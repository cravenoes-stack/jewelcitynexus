<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday, Maya!</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for the Game Board and Classy Country Theme */
        :root {
            --color-green-moss: #8b9d83;   /* Moss Green - Tractor */
            --color-red-barn: #c4453b;     /* Barn Red - Truck */
            --color-blue-sky: #7091a0;     /* Dusty Blue - ATV */
            --color-purple-lavender: #b57edc; /* Lavender - Carriage */
            --color-brown-saddle: #a0522d;   /* Saddle Brown - Pony */
            --color-yellow-sun: #f1c40f;    /* Bright Yellow - Boat */
            --color-gold: #e2b74f;         /* Classy Gold */
            --color-paper: #fffcf2;        /* Off-White Paper */
            --color-shadow: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-paper);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        #game-board {
            max-width: 900px;
            width: 100%;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--color-shadow), 0 0 0 8px var(--color-gold);
            background: linear-gradient(135deg, #f0e6d6 0%, #ffffff 100%);
            border: 5px solid var(--color-gold);
        }

        .vehicle {
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 130px; 
            width: 130px;
        }

        .vehicle:active {
            cursor: grabbing;
            z-index: 1000;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            transform: scale(1.08);
        }
        
        /* Styles for when the vehicle is locked in place */
        .vehicle.matched {
            cursor: default !important;
            box-shadow: 0 0 15px var(--color-gold) !important;
            opacity: 1;
            transform: none !important;
            transition: none;
        }
        
        .vehicle-label {
             font-size: 0.875rem;
             font-weight: 700;
             color: #4b5563;
             margin-bottom: 0.25rem;
        }

        .target {
            border: 4px dashed;
            border-radius: 16px;
            height: 130px;
            width: 130px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.4s ease-in-out;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            margin: 0.5rem;
        }
        
        /* Target Colors (Same as before) */
        .target-green { border-color: var(--color-green-moss); background-color: rgba(139, 157, 131, 0.05); }
        .target-red { border-color: var(--color-red-barn); background-color: rgba(196, 69, 59, 0.05); }
        .target-blue { border-color: var(--color-blue-sky); background-color: rgba(112, 145, 160, 0.05); }
        .target-purple { border-color: var(--color-purple-lavender); background-color: rgba(181, 126, 220, 0.05); }
        .target-brown { border-color: var(--color-brown-saddle); background-color: rgba(160, 82, 45, 0.05); }
        .target-yellow { border-color: var(--color-yellow-sun); background-color: rgba(241, 196, 15, 0.05); }

        /* Matched state for target */
        .target.filled {
            border-style: solid;
            border-width: 4px;
            box-shadow: 0 0 20px rgba(226, 183, 79, 0.7);
            opacity: 1;
        }
        .target-green.filled { border-color: var(--color-green-moss); background-color: rgba(139, 157, 131, 0.2); }
        .target-red.filled { border-color: var(--color-red-barn); background-color: rgba(196, 69, 59, 0.2); }
        .target-blue.filled { border-color: var(--color-blue-sky); background-color: rgba(112, 145, 160, 0.2); }
        .target-purple.filled { border-color: var(--color-purple-lavender); background-color: rgba(181, 126, 220, 0.2); }
        .target-brown.filled { border-color: var(--color-brown-saddle); background-color: rgba(160, 82, 45, 0.2); }
        .target-yellow.filled { border-color: var(--color-yellow-sun); background-color: rgba(241, 196, 15, 0.2); }


        /* SVG styles for the vehicles */
        .svg-icon {
            width: 85px;
            height: 85px;
            fill: currentColor; /* Use currentColor to inherit color from the parent's utility class */
        }
        .green-fill { color: var(--color-green-moss); }
        .red-fill { color: var(--color-red-barn); }
        .blue-fill { color: var(--color-blue-sky); }
        .purple-fill { color: var(--color-purple-lavender); }
        .brown-fill { color: var(--color-brown-saddle); }
        .yellow-fill { color: var(--color-yellow-sun); }

        /* The Win Modal */
        #win-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            animation: fadeIn 0.5s forwards;
            overflow-y: auto; /* Allow scrolling for modal content */
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn { 
            0% { transform: scale(0.5); opacity: 0; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        .modal-confetti {
            font-size: 2rem;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        /* Audio Button Feedback */
        #audio-button.playing {
            background-color: #6d28d9; /* Indigo 700 */
            box-shadow: 0 0 15px #a78bfa; /* Violet glow */
        }
    </style>
</head>
<body class="bg-gray-100 p-4">

    <div id="game-board">
        <h1 class="text-4xl font-black text-center mb-2 text-gray-800">
            Happy Birthday, <span class="text-amber-600">Maya!</span>
        </h1>
        <p class="text-center text-lg text-gray-600 mb-8">
            Park all <span class="font-extrabold text-gray-800">SIX</span> classy cruisers in their special spots!
        </p>

        <!-- Targets Section -->
        <div id="targets-container" class="flex justify-center flex-wrap gap-2 mb-10 p-2">
            <div data-vehicle="tractor" data-color="green" class="target target-green"><p class="text-gray-700 font-bold text-base text-center target-label">TRACTOR</p></div>
            <div data-vehicle="carriage" data-color="purple" class="target target-purple"><p class="text-gray-700 font-bold text-base text-center target-label">CARRIAGE</p></div>
            <div data-vehicle="truck" data-color="red" class="target target-red"><p class="text-gray-700 font-bold text-base text-center target-label">TRUCK</p></div>
            <div data-vehicle="boat" data-color="yellow" class="target target-yellow"><p class="text-gray-700 font-bold text-base text-center target-label">BOAT</p></div>
            <div data-vehicle="pony" data-color="brown" class="target target-brown"><p class="text-gray-700 font-bold text-base text-center target-label">PONY</p></div>
            <div data-vehicle="atv" data-color="blue" class="target target-blue"><p class="text-gray-700 font-bold text-base text-center target-label">4-WHEELER</p></div>
        </div>

        <!-- Draggable Vehicles Section -->
        <div id="vehicles-container" class="flex justify-center flex-wrap gap-4 p-4 bg-white/50 rounded-xl shadow-lg border border-gray-200">
            
            <!-- 1. ATV/Four-Wheeler (Blue) -->
            <div id="atv" data-vehicle="atv" data-color="blue" class="vehicle p-3 bg-white">
                <p class="vehicle-label">4-Wheeler</p>
                <svg viewBox="0 0 24 24" class="svg-icon blue-fill">
                    <path d="M11 15h2v2h-2zm-3-4h2v2H8zm6 0h2v2h-2zm-2-2c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v4c0 1.1-.9 2-2 2h-4c-1.1 0-2-.9-2-2zm-8 8H4v-2c0-1.1.9-2 2-2h2v4zm10 0h-4v-4h4c1.1 0 2 .9 2 2v2c0 1.1-.9 2-2 2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8z"/>
                </svg>
            </div>
            
            <!-- 2. Tractor (Green) -->
            <div id="tractor" data-vehicle="tractor" data-color="green" class="vehicle p-3 bg-white">
                <p class="vehicle-label">Tractor</p>
                <svg viewBox="0 0 24 24" class="svg-icon green-fill">
                    <path d="M21 15.5H18V13h3V9h-3V7.5C18 6.67 17.33 6 16.5 6h-3C12.67 6 12 6.67 12 7.5V11h-2V7.5C10 6.67 9.33 6 8.5 6h-3C4.67 6 4 6.67 4 7.5V13H1v2.5H4v4.5H1v1.5h22v-1.5h-2v-4.5zM6 13V9h2v4H6zm10 0V9h2v4h-2zM4 18h2v2H4v-2zm14 2h-2v-2h2v2z"/>
                </svg>
            </div>
            
            <!-- 3. Pony (Brown) -->
            <div id="pony" data-vehicle="pony" data-color="brown" class="vehicle p-3 bg-white">
                <p class="vehicle-label">Pony</p>
                <!-- Simple stylized horse profile -->
                <svg viewBox="0 0 24 24" class="svg-icon brown-fill">
                    <path d="M20 12c0-2.21-1.79-4-4-4H8c-2.21 0-4 1.79-4 4v2h2v-2c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v2h2v-2zm-8-7c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 15c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </div>

            <!-- 4. Truck (Red) -->
            <div id="truck" data-vehicle="truck" data-color="red" class="vehicle p-3 bg-white">
                <p class="vehicle-label">Truck</p>
                <svg viewBox="0 0 24 24" class="svg-icon red-fill">
                    <path d="M20 12c0-2.21-1.79-4-4-4H8c-2.21 0-4 1.79-4 4v2h2v-2c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v2h2v-2zm-8-7c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 15c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </div>

            <!-- 5. Boat (Yellow) -->
            <div id="boat" data-vehicle="boat" data-color="yellow" class="vehicle p-3 bg-white">
                <p class="vehicle-label">Boat</p>
                <svg viewBox="0 0 24 24" class="svg-icon yellow-fill">
                    <path d="M22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2h1v-2h14v2h1c1.1 0 2-.9 2-2V6zm-8 10h-4c-1.1 0-2 .9-2 2s.9 2 2 2h4c1.1 0 2-.9 2-2s-.9-2-2-2zM4 14v4h16v-4H4z"/>
                </svg>
            </div>

            <!-- 6. Carriage (Purple) -->
            <div id="carriage" data-vehicle="carriage" data-color="purple" class="vehicle p-3 bg-white">
                <p class="vehicle-label">Carriage</p>
                <!-- Simple stylized wagon/carriage -->
                <svg viewBox="0 0 24 24" class="svg-icon purple-fill">
                    <path d="M21 4H3C1.9 4 1 4.9 1 6v10c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-1 12H4V6h16v10zM6 16c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm12 0c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
                </svg>
            </div>
        </div>

        <!-- Reset Button -->
        <div class="text-center mt-8">
            <button id="reset-button" class="px-6 py-3 bg-amber-500 text-white font-bold rounded-full shadow-lg hover:bg-amber-600 transition transform hover:scale-105">
                Reset Game
            </button>
        </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="story-audio" style="display: none;"></audio>

    <!-- Win Modal -->
    <div id="win-modal" class="hidden flex justify-center items-start pt-16 pb-16">
        <div class="modal-content bg-white p-10 rounded-xl shadow-2xl max-w-xl w-full text-center border-8 border-amber-500">
            <div class="flex justify-center mb-4">
                <span class="modal-confetti text-amber-500">‚ú®</span>
                <span class="modal-confetti text-green-moss">üíö</span>
                <span class="modal-confetti text-red-barn">üéà</span>
                <span class="modal-confetti text-blue-sky">üíô</span>
                <span class="modal-confetti text-purple-lavender">üëë</span>
                <span class="modal-confetti text-yellow-sun">üåü</span>
                <span class="modal-confetti text-brown-saddle">üê¥</span>
            </div>
            <h2 class="text-4xl font-black text-amber-600 mb-4">
                <span class="block">YOU DID IT,</span> MAYA!
            </h2>
            <p class="text-xl text-gray-700 mb-6 font-bold" id="story-status">
                Now, let's read your special story...
                <span class="block text-sm text-gray-500 mt-2">
                    (Generating a magical storybook page...)
                </span>
            </p>
            
            <!-- Story Container (Loading/Content) -->
            <div id="story-container" class="bg-gray-50 p-6 rounded-lg text-left shadow-inner border border-gray-200">
                <div id="story-loading" class="flex justify-center items-center py-8">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-amber-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading Maya's Great Cruiser Adventure...
                </div>
                <div id="story-content" class="hidden text-lg text-gray-800 leading-relaxed font-serif whitespace-pre-wrap"></div>
            </div>

            <div class="flex justify-center mt-8 space-x-4">
                <button id="audio-button" class="px-6 py-3 bg-purple-600 text-white font-bold rounded-full shadow-lg hover:bg-purple-700 transition disabled:opacity-50 flex items-center" disabled>
                    <svg id="audio-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.121-9.193a8 8 0 010 11.314m-12.728-3.535a5 5 0 017.072 0m2.121 2.121a8 8 0 0111.314 0M4 12h4m-4 0v4m0-4v-4m16 4h-4m4 0v4m0-4v-4"></path></svg>
                    <span id="audio-text">Read Story Aloud</span>
                </button>
                <button onclick="location.reload()" class="px-6 py-3 bg-amber-500 text-white font-bold rounded-full shadow-lg hover:opacity-90 transition">
                    Park Them Again!
                </button>
            </div>
        </div>
    </div>

    <script>
        const vehicles = document.querySelectorAll('.vehicle');
        const targets = document.querySelectorAll('.target');
        const winModal = document.getElementById('win-modal');
        const resetButton = document.getElementById('reset-button');
        const storyStatus = document.getElementById('story-status');
        const storyLoading = document.getElementById('story-loading');
        const storyContent = document.getElementById('story-content');
        const audioButton = document.getElementById('audio-button');
        const storyAudio = document.getElementById('story-audio');
        const audioIcon = document.getElementById('audio-icon');
        const audioText = document.getElementById('audio-text');

        const TOTAL_ITEMS = 6; 
        const TEXT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";
        const API_KEY = ""; // Canvas provides this dynamically

        let activeItem = null;
        let isDragging = false;
        let initialX, initialY, currentX, currentY, xOffset = 0, yOffset = 0;
        let matchedCount = 0;

        // --- Utility Functions for API and Audio ---

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function runWithExponentialBackoff(fn, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                    const delayTime = Math.pow(2, attempt) * 1000 + Math.random() * 500;
                    console.warn(`Attempt ${attempt + 1} failed. Retrying in ${delayTime}ms...`);
                    await delay(delayTime);
                }
            }
        }
        
        // Converts base64 PCM data to a browser-playable WAV file Blob.
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset++, s.charCodeAt(i));
                }
            }
            function writeUint32(i) {
                view.setUint32(offset, i, true);
                offset += 4;
            }
            function writeUint16(i) {
                view.setUint16(offset, i, true);
                offset += 2;
            }

            // RIFF chunk
            writeString('RIFF');
            writeUint32(36 + pcm16.length * 2); // ChunkSize
            writeString('WAVE');
            
            // FMT chunk
            writeString('fmt ');
            writeUint32(16); // Subchunk1Size
            writeUint16(1);  // AudioFormat (1 is PCM)
            writeUint16(1);  // NumChannels (Mono)
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2); // ByteRate (SampleRate * NumChannels * BitsPerSample/8)
            writeUint16(2);  // BlockAlign (NumChannels * BitsPerSample/8)
            writeUint16(16); // BitsPerSample
            
            // DATA chunk
            writeString('data');
            writeUint32(pcm16.length * 2); // Subchunk2Size

            // Write PCM data (Int16)
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }


        // --- Game Logic Helpers ---

        function getEventPoint(e) {
            return e.changedTouches ? e.changedTouches[0] : e;
        }

        function setTranslate(xPos, yPos, el) {
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
        }

        function getVehicleSvg(vehicleElement) {
            return vehicleElement.querySelector('svg');
        }

        // --- Drag/Drop Handlers ---

        function dragStart(e) {
            activeItem = e.target.closest('.vehicle');
            if (!activeItem || activeItem.classList.contains('matched')) return;
            const point = getEventPoint(e);
            e.preventDefault();
            isDragging = true;
            
            const style = window.getComputedStyle(activeItem);
            const matrix = new WebKitCSSMatrix(style.transform);
            xOffset = matrix.m41;
            yOffset = matrix.m42;

            initialX = point.clientX - xOffset;
            initialY = point.clientY - yOffset;
            activeItem.style.zIndex = 1000;
        }

        function drag(e) {
            if (!isDragging || !activeItem) return;
            e.preventDefault();
            const point = getEventPoint(e);
            currentX = point.clientX - initialX;
            currentY = point.clientY - initialY;
            xOffset = currentX;
            yOffset = currentY;
            setTranslate(currentX, currentY, activeItem);
        }

        function dragEnd(e) {
            if (!activeItem || !isDragging) return;
            
            isDragging = false;
            activeItem.style.zIndex = 10; 
            const vehicleRect = activeItem.getBoundingClientRect();
            let isMatched = false;

            targets.forEach(target => {
                if (target.classList.contains('filled')) return;
                const targetRect = target.getBoundingClientRect();
                const vehicleCenter = {
                    x: vehicleRect.left + vehicleRect.width / 2,
                    y: vehicleRect.top + vehicleRect.height / 2
                };

                // Collision detection: check if vehicle center is inside target bounds
                if (vehicleCenter.x > targetRect.left && vehicleCenter.x < targetRect.right &&
                    vehicleCenter.y > targetRect.top && vehicleCenter.y < targetRect.bottom)
                {
                    // Match condition
                    if (activeItem.dataset.vehicle === target.dataset.vehicle && activeItem.dataset.color === target.dataset.color) {
                        isMatched = true;
                        
                        // Snap into place
                        const targetCenterX = targetRect.left + targetRect.width / 2;
                        const targetCenterY = targetRect.top + targetRect.height / 2;
                        const finalX = targetCenterX - vehicleRect.width / 2 - vehicleRect.left + currentX;
                        const finalY = targetCenterY - vehicleRect.height / 2 - vehicleRect.top + currentY;
                        setTranslate(finalX, finalY, activeItem);

                        // Update classes/display
                        activeItem.classList.add('matched');
                        activeItem.style.pointerEvents = 'none'; 
                        target.classList.add('filled');
                        
                        const vehicleSvg = getVehicleSvg(activeItem);
                        const clonedSvg = vehicleSvg.cloneNode(true);
                        clonedSvg.classList.remove('svg-icon');
                        clonedSvg.style.width = '100px';
                        clonedSvg.style.height = '100px';
                        
                        target.innerHTML = '';
                        target.appendChild(clonedSvg);

                        matchedCount++;
                        return;
                    }
                }
            });

            if (!isMatched) {
                setTranslate(0, 0, activeItem); // Return to start
            } else {
                if (matchedCount === TOTAL_ITEMS) {
                    setTimeout(showWinModal, 500);
                }
            }
            
            activeItem = null;
            xOffset = 0;
            yOffset = 0;
        }

        // --- Story Generation and TTS ---

        async function generateStory() {
            audioButton.disabled = true;
            storyStatus.innerHTML = `Generating a magical storybook page...`;
            storyLoading.classList.remove('hidden');
            storyContent.classList.add('hidden');

            const systemPrompt = "You are a cheerful, imaginative storyteller writing a very short, exciting story (3-4 paragraphs) for a four-year-old girl named Maya. The story must feature the six vehicles she just parked in her barn: a Moss Green Tractor, a Barn Red Truck, a Dusty Blue 4-Wheeler, a Lavender Carriage, a Saddle Brown Pony, and a Bright Yellow Boat. Use simple, direct language and focus on a fun adventure that involves all the vehicles. Do not include any HTML or markdown formatting in the story text. Just pure narrative.";
            const userQuery = "Tell a brand new, exciting story about Maya's great adventure using all her parked cruisers.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            try {
                const fetcher = async () => {
                    const response = await fetch(`${TEXT_API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API call failed: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorBody)}`);
                    }

                    return response.json();
                };

                const result = await runWithExponentialBackoff(fetcher);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Oh dear! The story got lost in the hay. Try parking them again!";

                storyStatus.innerHTML = `Your special story is ready!`;
                storyContent.innerText = text;
                storyContent.classList.remove('hidden');
                audioButton.disabled = false; // Enable TTS button
                
            } catch (e) {
                console.error("Story generation failed:", e);
                storyStatus.innerHTML = `Oh no! The story machine broke. <span class="text-red-500">(${e.message.substring(0, 50)}...)</span>`;
                storyContent.innerText = "We couldn't generate the story right now. Maybe try again, smart girl!";
                storyContent.classList.remove('hidden');
            } finally {
                storyLoading.classList.add('hidden');
            }
        }
        
        async function generateAndPlayTTS() {
            const storyText = storyContent.innerText;
            if (!storyText || audioButton.classList.contains('playing')) return;

            // UI feedback for loading audio
            audioButton.disabled = true;
            audioButton.classList.add('playing');
            audioText.textContent = 'Loading Audio...';

            const payload = {
                contents: [{ parts: [{ text: storyText }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" } // Cheerful, Upbeat voice
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const fetcher = async () => {
                    const response = await fetch(`${TTS_API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`TTS API failed: ${response.status} ${response.statusText}. Details: ${JSON.stringify(errorBody)}`);
                    }
                    return response.json();
                };
                
                const result = await runWithExponentialBackoff(fetcher);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    // Cleanup old URL if one exists
                    if (storyAudio.src) { URL.revokeObjectURL(storyAudio.src); }

                    const audioUrl = URL.createObjectURL(wavBlob);
                    storyAudio.src = audioUrl;
                    
                    // UI feedback for playing
                    audioText.textContent = 'Playing...';
                    storyAudio.play();
                } else {
                    throw new Error("Invalid audio format received from API.");
                }

            } catch (e) {
                console.error("TTS playback failed:", e);
                audioText.textContent = 'Audio Failed!';
            } finally {
                // Re-enable button and reset text when audio ends or fails
                storyAudio.onended = () => {
                    audioButton.disabled = false;
                    audioButton.classList.remove('playing');
                    audioText.textContent = 'Read Story Aloud';
                };
                
                if (storyAudio.paused) {
                    audioButton.disabled = false;
                    audioButton.classList.remove('playing');
                    audioText.textContent = 'Read Story Aloud';
                }
            }
        }


        function showWinModal() {
            winModal.style.display = 'flex';
            generateStory(); // Start story generation when modal is shown
        }

        function getTargetLabel(vehicle) {
            switch(vehicle) {
                case 'tractor': return 'TRACTOR';
                case 'truck': return 'TRUCK';
                case 'atv': return '4-WHEELER';
                case 'carriage': return 'CARRIAGE';
                case 'pony': return 'PONY';
                case 'boat': return 'BOAT';
                default: return '';
            }
        }

        function resetGame() {
            vehicles.forEach(v => {
                v.classList.remove('matched');
                v.style.pointerEvents = 'auto';
                v.style.transform = '';
                v.style.zIndex = 10;
            });

            targets.forEach(t => {
                t.classList.remove('filled');
                t.innerHTML = `<p class="text-gray-700 font-bold text-base text-center target-label">${getTargetLabel(t.dataset.vehicle)}</p>`;
            });
            
            // Stop and reset audio
            storyAudio.pause();
            storyAudio.src = '';
            audioButton.disabled = true;
            audioButton.classList.remove('playing');
            audioText.textContent = 'Read Story Aloud';

            matchedCount = 0;
            winModal.style.display = 'none';
            // Reset story display
            storyContent.classList.add('hidden');
            storyContent.innerText = '';
            storyLoading.classList.remove('hidden');
            storyStatus.innerHTML = `Now, let's read your special story...
                <span class="block text-sm text-gray-500 mt-2">
                    (Generating a magical storybook page...)
                </span>`;
        }

        // --- Event Listeners Setup ---

        vehicles.forEach(vehicle => {
            vehicle.addEventListener('mousedown', dragStart);
            vehicle.addEventListener('touchstart', dragStart);
            vehicle.style.position = 'relative';
        });
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', dragEnd);

        resetButton.addEventListener('click', resetGame);
        audioButton.addEventListener('click', generateAndPlayTTS);
        
        // Pause audio if the play button is clicked while audio is playing
        storyAudio.addEventListener('playing', () => {
            audioButton.classList.add('playing');
            audioText.textContent = 'Playing... (Tap to Pause)';
        });

        // Handle button click for pause/play
        audioButton.addEventListener('click', () => {
            if (audioButton.classList.contains('playing')) {
                storyAudio.pause();
                audioButton.classList.remove('playing');
                audioText.textContent = 'Paused (Tap to Resume)';
            } else if (storyAudio.src) {
                storyAudio.play();
            } else {
                // If clicked before the story is fully generated/loaded, call the function
                generateAndPlayTTS();
            }
        });
        
        storyAudio.addEventListener('pause', () => {
            audioButton.classList.remove('playing');
            audioText.textContent = 'Paused (Tap to Resume)';
        });

        storyAudio.addEventListener('ended', () => {
            audioButton.classList.remove('playing');
            audioText.textContent = 'Read Story Aloud';
        });

    </script>
</body>
    https://gemini.google.com/share/2436acaf9a43
</html>
