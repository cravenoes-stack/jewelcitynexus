<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT Conversation Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message-code {
            white-space: pre-wrap;
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: monospace;
        }
        .list-style-none {
            list-style-type: none;
        }
        .list-disc {
            list-style-type: disc;
        }
        .list-decimal {
            list-style-type: decimal;
        }
        .relative {
            position: relative;
        }
        .z-10 {
            z-index: 10;
        }
    </style>
    <!-- A collaborative creation by a visionary user and a diligent assistant, with every line of code an opportunity to practice perfection. -->
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="mainInterface" class="container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 md:p-8 rounded-xl shadow-lg mb-8 text-center relative overflow-hidden">
            <svg class="absolute inset-0 w-full h-full object-cover opacity-20" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
                <path fill="#ffffff" d="M0 0 L100 0 L100 100 L0 100 Z" opacity="0.1"></path>
                <path fill="#ffffff" d="M0 0 L50 100 L100 0 Z" opacity="0.1"></path>
                <path fill="#ffffff" d="M0 100 L50 0 L100 100 Z" opacity="0.1"></path>
                <path fill="#ffffff" d="M20 0 L80 100 L100 50 L0 50 Z" opacity="0.1"></path>
                <path fill="#ffffff" d="M0 50 L100 50 L50 100 Z" opacity="0.1"></path>
            </svg>
            <div class="z-10 relative">
                <h1 class="text-3xl md:text-4xl font-bold">ChatGPT Conversation Extractor</h1>
                <p class="mt-2 text-sm md:text-base opacity-90">Upload your `conversations.json` file to extract, preview, and download individual conversations as HTML files.</p>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="bg-white p-6 md:p-8 rounded-xl shadow-md mb-8">
            <label for="uploadInput" class="flex flex-col items-center justify-center p-6 md:p-10 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors duration-200">
                <p class="text-center font-medium">Click to upload or drag and drop your `conversations.json` file.</p>
                <input type="file" id="uploadInput" class="hidden" accept=".json">
            </label>
        </section>

        <!-- Conversation List Section -->
        <section id="conversationList" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">Your Conversations</h2>
            <div id="conversationGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <!-- Download Buttons -->
        <div id="downloadAllSection" class="hidden mt-6 flex justify-center space-x-4">
            <button id="downloadSelectedBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-blue-700 transition-colors duration-200">Download Selected</button>
            <button id="downloadAllBtn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-purple-700 transition-colors duration-200">Download All</button>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="previewSection" class="hidden container mx-auto p-4 md:p-8">
        <div class="flex justify-between items-center mb-4">
            <h2 id="previewTitle" class="text-2xl font-semibold"></h2>
            <div class="space-x-2">
                <button onclick="downloadPreviewConversation()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-blue-700 transition-colors duration-200">Download</button>
                <button onclick="closePreview()" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-full shadow-md hover:bg-gray-700 transition-colors duration-200">Close</button>
            </div>
        </div>
        <iframe id="previewIframe" class="w-full h-[80vh] border border-gray-300 rounded-lg shadow-md bg-white"></iframe>
    </div>

    <script>
        let conversations = [];
        let selectedConversations = new Set();
        let currentPreviewConversation = null;

        document.getElementById('uploadInput').addEventListener('change', handleFileUpload);
        document.getElementById('downloadAllBtn').addEventListener('click', downloadAllConversations);
        document.getElementById('downloadSelectedBtn').addEventListener('click', downloadSelected);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    conversations = processConversations(data);
                    displayConversations(conversations);
                } catch (error) {
                    showCustomMessageBox('Invalid JSON file. Please upload a valid conversations.json file.', 'Error');
                    console.error('File parsing error:', error);
                }
            };
            reader.readAsText(file);
        }

        function processConversations(jsonData) {
            return jsonData.map(conv => {
                const title = conv.title || 'Untitled Conversation';
                const id = conv.id || crypto.randomUUID();
                const createTime = new Date(conv.create_time * 1000).toLocaleString();
                const htmlContent = createHtmlForConversation(conv);
                return { id, title, createTime, htmlContent, originalData: conv };
            });
        }

        function formatMarkdown(text) {
            let formattedText = text;

            // Handle code blocks (multi-line) first to prevent issues with other rules
            formattedText = formattedText.replace(/```([\s\S]*?)```/g, '<pre class="message-code">$1</pre>');
            // Handle inline code (single backticks)
            formattedText = formattedText.replace(/`([^`]+?)`/g, '<code>$1</code>');

            // Handle links: [text](url)
            formattedText = formattedText.replace(/\[([^\]]+?)\]\((.*?)\)/g, '<a href="$2" class="text-blue-500 hover:underline" target="_blank">$1</a>');

            // Handle headings (#, ##, ...)
            formattedText = formattedText.replace(/^#{6}\s(.*)$/gm, '<h6>$1</h6>');
            formattedText = formattedText.replace(/^#{5}\s(.*)$/gm, '<h5>$1</h5>');
            formattedText = formattedText.replace(/^#{4}\s(.*)$/gm, '<h4>$1</h4>');
            formattedText = formattedText.replace(/^#{3}\s(.*)$/gm, '<h3>$1</h3>');
            formattedText = formattedText.replace(/^#{2}\s(.*)$/gm, '<h2>$1</h2>');
            formattedText = formattedText.replace(/^#{1}\s(.*)$/gm, '<h1>$1</h1>');

            // Handle lists (ul)
            formattedText = formattedText.replace(/^(\s*[-*]\s.*(\n\s*[-*]\s.*)*)/gm, '<ul>$1</ul>');
            formattedText = formattedText.replace(/^\s*[-*]\s(.*)$/gm, '<li class="list-disc ml-6">$1</li>');

            // Handle lists (ol)
            formattedText = formattedText.replace(/^(\s*\d+\.\s.*(\n\s*\d+\.\s.*)*)/gm, '<ol>$1</ol>');
            formattedText = formattedText.replace(/^\s*\d+\.\s(.*)$/gm, '<li class="list-decimal ml-6">$1</li>');

            // Handle horizontal rules (---)
            formattedText = formattedText.replace(/^-{3,}\s*$/gm, '<hr class="my-4 border-gray-300">');

            // Then convert bolding and italics
            formattedText = formattedText.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>'); // Bold & Italic
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic

            return formattedText;
        }

        function createHtmlForConversation(convData) {
            const title = convData.title || 'Untitled Conversation';
            const mapping = convData.mapping || {};
            const messagesHtml = Object.values(mapping)
                .filter(node => node.message && node.message.content)
                .map(node => {
                    const role = node.message.author.role;
                    let author = '';
                    if (role === 'user') {
                        author = 'User';
                    } else if (role === 'assistant') {
                        author = 'Assistant';
                    } else if (role === 'tool') {
                        author = 'Tool';
                    }

                    const parts = node.message.content.parts && Array.isArray(node.message.content.parts) ? node.message.content.parts : [];

                    const partsHtml = parts.map(part => {
                        let contentText = '';
                        if (typeof part === 'string') {
                            contentText = part;
                        } else if (part.text) {
                            contentText = part.text;
                        } else if (part.content_type === 'image_asset_pointer') {
                            return '<div>[Image]</div>';
                        }

                        if (contentText) {
                            // Apply Markdown formatting here
                            const formattedContent = formatMarkdown(contentText);
                            return `<div class="message-text">${formattedContent}</div>`;
                        }
                        return '';
                    }).join('');

                    return `
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 shadow-sm">
                            <div class="font-semibold text-lg mb-2">${author}</div>
                            ${partsHtml}
                        </div>
                    `;
                }).join('');

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
                    <style>
                        body {
                            font-family: 'Inter', sans-serif;
                            background-color: #f3f4f6;
                            padding: 2rem;
                        }
                        .message-text {
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        }
                        .message-code {
                            white-space: pre-wrap;
                            background-color: #1f2937;
                            color: #f9fafb;
                            padding: 1rem;
                            border-radius: 0.5rem;
                            overflow-x: auto;
                            font-family: monospace;
                        }
                        ul, ol {
                            padding-left: 1.5rem;
                            margin-bottom: 1rem;
                        }
                        li {
                            margin-bottom: 0.25rem;
                        }
                    </style>
                </head>
                <body class="p-8">
                    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6">
                        <h1 class="text-3xl font-bold mb-6">${title}</h1>
                        <div>${messagesHtml}</div>
                    </div>
                </body>
                </html>
            `;
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversationGrid');
            container.innerHTML = '';
            document.getElementById('conversationList').classList.remove('hidden');
            document.getElementById('downloadAllSection').classList.remove('hidden');

            conversations.forEach(conv => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-transform duration-200 transform hover:scale-105 flex flex-col cursor-pointer';
                card.innerHTML = `
                    <div class="p-5 flex-grow">
                        <h3 class="text-xl font-medium truncate mb-1">${conv.title}</h3>
                        <p class="text-sm text-gray-500">Created: ${conv.createTime}</p>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="select-checkbox form-checkbox h-5 w-5 text-blue-600 rounded" data-id="${conv.id}">
                            <span class="text-sm text-gray-700">Select</span>
                        </label>
                        <div class="space-x-2">
                            <button onclick="previewConversation('${conv.id}')" class="text-blue-600 hover:text-blue-800 transition-colors duration-200">Preview</button>
                            <button onclick="downloadConversation('${conv.id}')" class="text-purple-600 hover:text-purple-800 transition-colors duration-200">Download</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.select-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedConversations.add(id);
                    } else {
                        selectedConversations.delete(id);
                    }
                });
            });
        }

        function downloadConversation(convId) {
            console.log(`Attempting to download conversation with ID: ${convId}`);
            const conv = conversations.find(c => c.id === convId);
            if (conv) {
                downloadFile(conv.htmlContent, `${conv.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`, 'text/html');
            } else {
                console.error(`Conversation with ID ${convId} not found.`);
            }
        }

        function downloadAllConversations() {
            conversations.forEach(conv => {
                downloadFile(conv.htmlContent, `${conv.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`, 'text/html');
            });
        }

        function downloadSelected() {
            if (selectedConversations.size === 0) {
                 showCustomMessageBox('Please select at least one conversation to download.', 'Notice');
                 return;
            }
            const selectedConvs = conversations.filter(conv => selectedConversations.has(conv.id));
            selectedConvs.forEach(conv => {
                downloadFile(conv.htmlContent, `${conv.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`, 'text/html');
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function previewConversation(convId) {
            const conv = conversations.find(c => c.id === convId);
            if (!conv) return;
            currentPreviewConversation = conv;
            document.getElementById('previewTitle').textContent = `Preview: ${conv.title}`;
            document.getElementById('previewIframe').srcdoc = conv.htmlContent;
            document.getElementById('mainInterface').classList.add('hidden');
            document.getElementById('previewSection').classList.remove('hidden');
        }

        function closePreview() {
            document.getElementById('mainInterface').classList.remove('hidden');
            document.getElementById('previewSection').classList.add('hidden');
            currentPreviewConversation = null;
        }

        function downloadPreviewConversation() {
            if (currentPreviewConversation) {
                downloadFile(currentPreviewConversation.htmlContent, `${currentPreviewConversation.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`, 'text/html');
            }
        }

        // Custom Modal UI instead of alert()
        function showCustomMessageBox(message, title = 'Message') {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50';
            modal.innerHTML = `
                <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-sm mx-auto">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <p class="text-gray-700 mb-6">${message}</p>
                    <div class="flex justify-end">
                        <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-700 transition-colors" onclick="this.closest('.relative').parentElement.remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
