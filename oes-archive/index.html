<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OES Archive</title>
  <link href="https://cdn.tailwindcss.com" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-8">
    <h1 class="text-2xl font-bold mb-4">Operator Evolution System Archive</h1>

    <!-- Upload & Process Panel -->
    <div class="mb-6">
      <label class="block mb-2">Upload JSON Transcripts</label>
      <input id="json-file"
             type="file"
             accept="application/json"
             multiple
             class="border px-2 py-1">
      <button id="process-btn"
              class="ml-2 bg-blue-600 text-white px-4 py-1 rounded">
        Process Transcripts
      </button>
    </div>

    <!-- Rendered Conversation Cards -->
    <div id="review-commit" class="space-y-4">
      <!-- each processed conversation card will appear here -->
    </div>

    <!-- Commit Button -->
    <button id="commit-btn"
            class="mt-6 bg-green-600 text-white px-4 py-2 rounded">
      Commit Selected to Repo
    </button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const processBtn     = document.getElementById('process-btn');
      const fileInput      = document.getElementById('json-file');
      const reviewContainer= document.getElementById('review-commit');
      const commitBtn      = document.getElementById('commit-btn');

      let conversations = [];

      // === EXISTING: Load & parse uploaded JSON transcripts ===
      processBtn.addEventListener('click', async () => {
        const files = Array.from(fileInput.files);
        conversations = [];
        for (let file of files) {
          const text = await file.text();
          const data = JSON.parse(text);
          // assume data.conversations is your array
          conversations.push(...data.conversations);
        }
        renderCategorizedConversations(conversations);
      });

      // === EXISTING: Commit selected conversations to your repo ===
      commitBtn.addEventListener('click', () => {
        const selected = conversations.filter(conv => {
          return document.getElementById('select-' + conv.id).checked;
        });
        // …your existing logic to push selected items back to Git, API, etc…
      });

      // === EXISTING: Render cards + NEW Preview & Download buttons ===
      function renderCategorizedConversations(convs) {
        reviewContainer.innerHTML = '';
        convs.forEach(conv => {
          const card = document.createElement('div');
          card.className = 'conversation-card p-4 bg-white rounded shadow flex items-start';

          card.innerHTML = `
            <input type="checkbox"
                   id="select-${conv.id}"
                   class="mr-3"
            />
            <div class="flex-1">
              <label for="select-${conv.id}"
                     class="font-semibold cursor-pointer">
                ${conv.title}
              </label>
              <p class="text-sm text-gray-500 mt-1">
                ${conv.platform} – ${conv.fullText.substring(0, 100)}...
              </p>
            </div>
            <div class="flex flex-col space-y-2 ml-4">
              <button type="button"
                      class="view-btn bg-gray-200 hover:bg-gray-300 text-xs px-2 py-1 rounded">
                Preview
              </button>
              <button type="button"
                      class="download-btn bg-blue-600 hover:bg-blue-700 text-xs text-white px-2 py-1 rounded">
                Download HTML
              </button>
            </div>
          `;

          // --- NEW: wire up Preview & Download ---
          const viewBtn     = card.querySelector('.view-btn');
          const downloadBtn = card.querySelector('.download-btn');
          let blobUrl = null;

          function ensureBlob() {
            if (!blobUrl) {
              const html = generateConversationHTML(conv);
              const blob = new Blob([html], { type: 'text/html' });
              blobUrl = URL.createObjectURL(blob);
            }
          }

          viewBtn.addEventListener('click', () => {
            ensureBlob();
            window.open(blobUrl, '_blank');
          });

          downloadBtn.addEventListener('click', () => {
            ensureBlob();
            const a = document.createElement('a');
            a.href = blobUrl;
            // sanitize filename
            a.download = conv.title
              .replace(/\s+/g, '_')
              .replace(/[^\w\-]/g, '') + '.html';
            a.click();
          });

          reviewContainer.appendChild(card);
        });
      }

      // === NEW: Build a standalone HTML document for each conversation ===
      function generateConversationHTML(conv) {
        const safeText = conv.fullText
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\n/g, '<br>');

        return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${conv.title}</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9fafb; }
    h1 { margin-bottom: 1rem; }
    pre { background: #fff; padding: 1rem; border: 1px solid #ddd; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>${conv.title}</h1>
  <pre>${safeText}</pre>
</body>
</html>`;
      }
    });
  </script>
</body>
</html>
