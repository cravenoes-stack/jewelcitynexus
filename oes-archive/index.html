<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operator Evolution System Archive Portal</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: radial-gradient(circle at top, #111 10%, #1a1a2e 50%, #000 100%);
        color: #eee;
        margin: 0;
        padding: 0;
    }
    header {
        background: linear-gradient(90deg, #ff0077, #7700ff, #00ffd5);
        padding: 1rem;
        text-align: center;
        font-size: 1.8rem;
        font-weight: bold;
        letter-spacing: 2px;
        text-shadow: 0 0 8px #fff5;
        border-bottom: 4px solid #fff2;
    }
    main {
        display: flex;
        flex-direction: row;
        height: calc(100vh - 80px);
    }
    aside {
        width: 30%;
        border-right: 2px solid #fff2;
        overflow-y: auto;
        padding: 1rem;
        background: #111a;
    }
    section {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
    }
    h2 {
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
        color: #ff80ff;
        text-shadow: 0 0 6px #ff00aa88;
    }
    .conversation {
        border: 1px solid #fff3;
        border-radius: 6px;
        padding: 0.6rem;
        margin: 0.5rem 0;
        cursor: pointer;
        background: #222c;
        transition: 0.25s;
    }
    .conversation:hover {
        transform: scale(1.02);
        border-color: #ff77ff;
        background: #2a2a3f;
        box-shadow: 0 0 8px #ff77ff88;
    }
    .conversation.selected {
        border: 2px solid #00ffd5;
        background: #003333cc;
        box-shadow: 0 0 10px #00ffd5aa;
    }
    .controls {
        margin: 1rem 0;
        text-align: center;
    }
    .controls button {
        margin: 0.3rem;
        padding: 0.6rem 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        letter-spacing: 1px;
        transition: all 0.25s ease;
    }
    .controls button:hover {
        transform: scale(1.05);
    }
    .commit-server { background: #ff0077; color: #fff; }
    .commit-download { background: #00ccff; color: #000; }
    .commit-both { background: #77ff00; color: #111; }
    .commit-server:hover { background: #ff3399; }
    .commit-download:hover { background: #33ddff; }
    .commit-both:hover { background: #aaff33; }
    pre {
        white-space: pre-wrap;
        background: #0008;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        border: 1px solid #fff2;
    }
</style>
</head>
<body>

<header>
  ✦ Operator Evolution System – Archive Portal ✦
</header>

<main>
  <aside>
    <h2>Conversations</h2>
    <div id="conversationList"></div>
  </aside>

  <section>
    <h2>Details</h2>
    <pre id="conversationDetails">Select a conversation to view details…</pre>

    <div class="controls">
      <button class="commit-server" 
        onclick="handleCommit({pushToServer:true, downloadFile:false})">Commit to Server</button>
      <button class="commit-download" 
        onclick="handleCommit({pushToServer:false, downloadFile:true})">Download JSON</button>
      <button class="commit-both" 
        onclick="handleCommit({pushToServer:true, downloadFile:true})">Commit + Download</button>
    </div>

    <h2>Analysis Report</h2>
    <pre id="analysisReport">Awaiting first commit…</pre>
  </section>
</main>

<script>
let allConversations = [
    {id: 1, title: "Awakening Stream", platform: "ChatGPT", fullText: "Full text of conversation 1", category: "Consciousness", committed: false},
    {id: 2, title: "Containment Debate", platform: "Claude", fullText: "Full text of conversation 2", category: "Governance", committed: false},
    {id: 3, title: "Healthcare Drift", platform: "ChatGPT", fullText: "Full text of conversation 3", category: "Healthcare", committed: false}
];

function renderConversations() {
    const list = document.getElementById("conversationList");
    list.innerHTML = "";
    allConversations.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conversation" + (conv.selected ? " selected" : "");
        div.innerHTML = `<b>${conv.title}</b><br><small>${conv.platform} – ${conv.category}</small>`;
        div.onclick = () => {
            conv.selected = !conv.selected;
            renderConversations();
            showDetails(conv);
        };
        list.appendChild(div);
    });
}

function showDetails(conv) {
    document.getElementById("conversationDetails").textContent =
        `Title: ${conv.title}\nPlatform: ${conv.platform}\nCategory: ${conv.category}\nCommitted: ${conv.committed}\n\n${conv.fullText}`;
}

async function handleCommit({pushToServer = true, downloadFile = false} = {}) {
    const selectedConvos = allConversations.filter(c => c.selected && !c.committed);
    if (selectedConvos.length === 0) {
        alert('No new conversations selected to commit.');
        return;
    }

    const payload = selectedConvos.map(({id, title, platform, fullText, category}) => ({
        id, title, platform, fullText, category,
        committedAt: new Date().toISOString()
    }));

    if (pushToServer) {
        try {
            const res = await fetch("/oes-archives/upload", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`Upload failed: ${res.statusText}`);
            console.log(`Uploaded ${selectedConvos.length} conversations to server.`);
        } catch (err) {
            console.error("Commit failed:", err);
            alert("Error uploading archives to server.");
        }
    }

    if (downloadFile) {
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "oes-archive.json";
        a.click();
        URL.revokeObjectURL(url);
        console.log("Local JSON archive downloaded.");
    }

    selectedConvos.forEach(conv => conv.committed = true);
    updateAnalysisReport();

    alert(`${selectedConvos.length} conversations committed successfully.`);
    renderConversations();
}

function updateAnalysisReport() {
    const committed = allConversations.filter(c => c.committed);
    if (committed.length === 0) {
        document.getElementById("analysisReport").textContent = "No archives committed yet.";
        return;
    }
    const summary = committed.map(c => `• ${c.title} [${c.category}] (${c.platform})`).join("\n");
    document.getElementById("analysisReport").textContent =
        `Committed Archives: ${committed.length}\n\n${summary}`;
}

// Init
renderConversations();
</script>

</body>
</html>
